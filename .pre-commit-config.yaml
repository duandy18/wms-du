# .pre-commit-config.yaml — WMS-DU stable hooks (FINAL VERSION)

repos:
  # ================================================
  # 1) Ruff: Python linter + formatter (高速 + 全替代 flake8)
  # ================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.6.8
    hooks:
      - id: ruff
        name: ruff lint
        args: ["--fix"]
        files: ^(app|tests|scripts|tools)/.*\.py$

      - id: ruff-format
        name: ruff format
        files: ^(app|tests|scripts|tools)/.*\.py$
        stages: [manual]   # 只在手动运行时格式化（安全，不强行影响 commit）

  # ================================================
  # 2) Black / isort: 手动触发（保持工程可控）
  # ================================================
  - repo: https://github.com/psf/black
    rev: 25.1.0
    hooks:
      - id: black
        files: ^(app|tests|scripts|tools)/.*\.py$
        stages: [manual]

  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        files: ^(app|tests|scripts|tools)/.*\.py$
        args: ["--profile", "black"]
        stages: [manual]

  # ================================================
  # 3) 基础卫生检查（全仓库）
  # ================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: end-of-file-fixer
      - id: trailing-whitespace
      - id: mixed-line-ending

  # ================================================
  # 4) Normalize punctuation（测试文件）
  # ================================================
  - repo: local
    hooks:
      - id: normalize-punct-tests
        name: Normalize fullwidth punctuation (tests)
        language: system
        entry: bash -lc 'python tools/normalize_punct.py tests'
        files: ^tests/.*\.py$
        pass_filenames: false
        stages: [manual]

  # ================================================
  # 5) detect-secrets（安全扫描，但不阻断提交）
  # ================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args:
          - --baseline
          - .secrets.baseline
          - --exclude-files
          - '(alembic/versions\.bak/|docs/|canvas/|.*\.md$|.*\.bak$)'
        pass_filenames: false
        stages: [manual]  # 仅手动或 CI 执行，不影响普通 commit

  # ================================================
  # 6) mypy（类型检查，push 前触发：不会打断开发节奏）
  # ================================================
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.10.0
    hooks:
      - id: mypy
        files: ^app/.*\.py$
        stages: [pre-push]
        args:
          - --ignore-missing-imports
          - --install-types
          - --non-interactive
        additional_dependencies:
          - pydantic>=2
          - pydantic-core>=2
          - pydantic-settings>=2

# ================================================
# 7) 可选：前端 Prettier / ESLint（未来加入）
# ================================================
# repos:
#   - repo: https://github.com/pre-commit/mirrors-prettier
#     rev: v3.1.0
#     hooks:
#       - id: prettier
#         types_or: ["json", "yaml", "markdown", "javascript", "typescript", "tsx"]

# pytest.ini
# WMS-DU · 本地/CI 一致化测试配置（带“可观测性”按摩式注释）

[pytest]
# 1) 测试搜索路径
testpaths = tests

# 2) 常用选项：-q 安静，-s 直出打印（别吞 stdout）
addopts = -q -s

# 3) 标记注册：消除 Unknown mark 警告
markers =
    quick: quick 针刺测试
    smoke: smoke 冒烟测试

# 4) asyncio 模式：自动管理事件循环
asyncio_mode = auto

# 5) 环境变量（pytest-env 插件读取）
#    - OTEL_*：让本机跑 pytest 时把 trace 直接送到本机 Collector（localhost:4317）
#    - 如需临时关闭，可在命令前覆盖：OTEL_TRACES_SAMPLER=never PYTHONPATH=. pytest ...
env =
    # Python 导入路径
    PYTHONPATH=.

    # 数据库：本机 Postgres（与 dev 栈一致，5433）
    DATABASE_URL=postgresql+psycopg://wms:wms@127.0.0.1:5433/wms

    # 测试使用的 JWT 秘钥（仅本地用）
    JWT_SECRET=test-ci-secret

    # ==== OpenTelemetry（本机直连 Collector）====
    # 采样策略：全开，便于在 Jaeger 看到每次测试的 Trace
    OTEL_TRACES_SAMPLER=always_on
    # 导出端点：Collector 的 gRPC（我们已经让它监听 0.0.0.0:4317）
    OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
    # 服务名统一：让 Jaeger 下拉里显示为 wms-du
    OTEL_SERVICE_NAME=wms-du

# 6) 告警过滤
#    你在本机看到的两类警告（google._upb / pkg_resources）这里做静默处理；
#    升级到 Py3.14 / Setuptools 81+ 后可再评估是否移除。
filterwarnings =
    # Python 内置：utcnow 弃用提示（我们在迁移窗口内忽略）
    ignore:datetime\.datetime\.utcnow\(\) is deprecated:DeprecationWarning
    # Google protobuf in upb: Py3.14 前的兼容告警
    ignore:Type google\._upb\._message\..* uses PyType_Spec.*:DeprecationWarning
    # opentelemetry 依赖路径里触发的 pkg_resources 弃用告警（Setuptools <81）
    ignore:pkg_resources is deprecated as an API:UserWarning

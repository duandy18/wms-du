# WMS-DU｜CI 体检 / 自愈清单（run.sh 预修复 & Reset）

> 目的：把 **CI 转发器 + run.sh** 的预修复、迁移自愈、Smoke 前 Reset 与健康检查，沉淀为“一键绿”清单，确保本地与 CI 行为一致、可回退、可追责。

---

## A. 总体原则

- **少动 CI，多用 run.sh**：工作流 YAML 只调用固定入口（`.github/ci/run.sh`），核心逻辑沉到仓库根 `run.sh`。
- **迁移自愈优先**：遇到历史库/半旧库/空库，先修复 `alembic_version` 与关键约束，再跑 `alembic upgrade head`。
- **同会话/同引擎**：HTTP 路由使用可覆盖的 `get_session`，测试通过 `dependency_overrides` 覆盖到同一 AsyncEngine。
- **账实一致 + 幂等**：`stock_ledger` 写全 `item_id / occurred_at / ref_line`；PUTAWAY 两腿“右腿 +1”；Inbound 幂等第二次返回 409。

---

## B. run.sh 结构（关键任务）

- `task_pg_migrate`
  - **fix_alembic_version_len**（预修复）：
    - 若无 `public.alembic_version` → 新建 `version_num VARCHAR(255)` 并写入 **baseline**（`f995a82ac74e`）。
    - 若列长 < 128 → `ALTER COLUMN version_num TYPE VARCHAR(255)`。
    - 若表空 → 插入 baseline。
  - `alembic upgrade head`

- `task_pg_health`
  - 可选：`tools/pg_healthcheck.py --strict` 输出 `pg_health/report.json`。
  - 必跑：`tools/db_invariants.py`（**不变量断言**）：
    - `stocks(item_id, location_id)` 唯一；
    - `stock_ledger.stock_id → stocks.id` 外键存在；
    - （如需）`stock_ledger.item_id` 非空性/回填触发器在位。

- `task_quick`
  - `pytest -q tests/quick -m "not slow" --maxfail=1 --durations=10`

- `task_smoke`
  - **db_hard_reset**：
    1. `DROP SCHEMA public CASCADE; CREATE SCHEMA public;`
    2. **fix_alembic_version_len**（再次预修复，防止 `VARCHAR(32)` 恢复）；
    3. `alembic upgrade head`（执行完整迁移链，自愈包含：
       - `items.id` 自增（IDENTITY/Sequence）；
       - `batches` 缺表/缺列（`qty`）自动补；
       - `stock_snapshots` 列名 (`snapshot_date`) 与 `as_of_ts` 默认兜底；
       - `stock_ledger.item_id` 补列 + 回填 + NOT NULL；
       - 触发器 `trg_stock_ledger_fill_item_id`（兼容旧 SQL 未写 `item_id`）；
       - **merge heads** 保持单一 head）。
  - `pytest -q tests/smoke --maxfail=1 --durations=10`

---

## C. 数据层自愈策略（迁移层）

1) **Alembic 版本表扩列**

- 现象：`StringDataRightTruncation: VARCHAR(32)` 写不下长 revision。
- 处理：`alembic_version.version_num` → `VARCHAR(255)`；缺表时建表并写 baseline。

2) **items.id 自增**

- 现象：`INSERT INTO items (sku,name)` 报 `id NOT NULL`。
- 处理：优先 `GENERATED BY DEFAULT AS IDENTITY`；旧版 PG 回退 `SEQUENCE + DEFAULT nextval()`。

3) **batches 缺表/缺列**

- 缺表：幂等创建 `batches`（含复合唯一 `item, warehouse, location, code, prod, exp` 与覆盖索引）。
- 缺 `qty`：`ALTER TABLE ... ADD COLUMN qty INTEGER NOT NULL DEFAULT 0; DROP DEFAULT`。

4) **stock_snapshots 兼容**

- `snapshot_date`：rename `snap_date`/`date` → `snapshot_date`（或新增）。
- `as_of_ts`：`SET DEFAULT CURRENT_TIMESTAMP`（避免 NOT NULL 插入报错，必要时应用也写 `as_of_ts`）。

5) **stock_ledger.item_id 上线**

- 迁移：`ADD COLUMN item_id INTEGER` → 回填 `stock_id→stocks.item_id` → `SET NOT NULL` → `INDEX(item_id)`。
- 触发器：`BEFORE INSERT` 若 `NEW.item_id IS NULL`，自动由 `stock_id→stocks.item_id` 回填。

6) **并发造数兼容**

- `locations` **取消** `(warehouse_id, name)` 唯一约束（并发 putaway 测试允许多处 “STAGE”）。

---

## D. 应用层对齐项

- Inbound：
  - 写 `stock_ledger` 时带 `item_id / occurred_at / ref_line`；
  - 幂等预检：`(reason='INBOUND', ref, ref_line)` 已存在 → 409/208（对外统一 409）；
  - 批次冲突：同 `(item, wh, loc, code)` 但效期不同 → 422。

- Putaway：
  - 两腿记账：来源腿 `ref_line`，目标腿 `ref_line+1`；
  - `NEGATIVE_STOCK` → 409；
  - 批量并发：`FOR UPDATE SKIP LOCKED`，每处理一行 `COMMIT` 释放锁；
  - 直写 SQL 也写 `occurred_at`；如未写 `item_id`，触发器兜底。

- 路由会话：
  - 导出可覆盖依赖 `app.api.endpoints.inbound.get_session`；
  - 测试覆盖 `app.dependency_overrides[inbound.get_session] = async_session_maker`，HTTP 与断言同库同会话。

---

## E. 体检与断言（最小集）

- **结构体检**（`tools/pg_healthcheck.py --strict`）：表/列/索引/约束 与 `scripts/db_spec.json` 对齐。
- **不变量断言**（`tools/db_invariants.py`）：
  - `stocks(item_id, location_id)` 唯一；
  - `stock_ledger.stock_id → stocks.id` 外键存在；
  - （如启用）`stock_ledger.item_id` 非空且触发器在位。
- **账实审计**（Smoke）：
  - Inbound(+10) + Putaway(-7/+7) → `Σdelta == 10`；
  - `(item_id=1, loc0/101) == (3,7)`；
  - 错误码：`INVALID_BARCODE(400) / BATCH_EXPIRY_CONFLICT(422) / IDEMPOTENT(409) / NEGATIVE_STOCK(409)`。

---

## F. 故障指北（常见红灯 → 处置）

- **VARCHAR(32) 截断**：先执行 `fix_alembic_version_len` 再 `alembic upgrade head`。
- **多 head**：`alembic heads -v` → `alembic merge H1 H2 ...` 合并；新迁移的 `down_revision` 指向唯一 head。
- **items.id NOT NULL**：执行 `items_id_identity` 迁移（IDENTITY/Sequence）。
- **ledger.occurred_at NOT NULL**：应用写 `occurred_at` 或给默认；
- **ledger.item_id NOT NULL**：应用写 `item_id` + 触发器兜底（兼容老 SQL）。
- **并发 putaway 造数撞唯一**：删除 `locations(warehouse_id,name)` 唯一约束。

---

## G. 一键执行（本地 / CI 同步）

```bash
# 全链路（迁移 → 体检 → quick → reset → smoke）
./run.sh ci:pg:all

# 仅迁移
./run.sh ci:pg:migrate

# 迁移 + 体检（不跑用例）
./run.sh ci:pg:health

# 只跑 quick
./run.sh ci:pg:quick

# 只跑 smoke（会先 reset）
./run.sh ci:pg:smoke
```

> 若 Smoke 前 reset 导致 `alembic_version` 回到 32 长度，`fix_alembic_version_len` 会把列扩到 `VARCHAR(255)` 并写入 baseline、再升级。

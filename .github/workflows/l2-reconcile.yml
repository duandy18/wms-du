name: L2 Reconcile (Shadow CSV Artifact)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: l2-reconcile-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  PYTHONPATH: "."
  TZ: Asia/Shanghai
  # ä¸Žé¡¹ç›®ä¸€è‡´ï¼šå®¹å™¨ 5432 â†’ host 5433
  DATABASE_URL: postgresql+psycopg://wms:wms@127.0.0.1:5433/wms
  # å½±å­æ¨¡å¼ï¼šä¸ä»Žå¹³å°æ‹‰çœŸå®žåº“å­˜ï¼ˆå¦‚éœ€æ‹‰æ•°æ”¹ä¸º trueï¼‰
  ENABLE_PDD_PULL: "false"

jobs:
  reconcile-shadow:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ðŸ“¦ Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends postgresql-client

      - name: ðŸ“¦ Install Python deps
        run: |
          python -m pip install -U pip wheel setuptools
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f .github/ci/requirements-ci.txt ]; then pip install -r .github/ci/requirements-ci.txt; fi
          pip install "psycopg[binary]>=3.1" asyncpg

      - name: ðŸ˜ Start Postgres 14 (5433)
        run: |
          docker run -d --rm --name pg14 \
            -e POSTGRES_USER=wms \
            -e POSTGRES_PASSWORD=wms \
            -e POSTGRES_DB=wms \
            -p 5433:5432 postgres:14
          # ç­‰å¾…æ•°æ®åº“å¯ç”¨
          for i in {1..120}; do
            pg_isready -h 127.0.0.1 -p 5433 && break
            sleep 1
          done
          pg_isready -h 127.0.0.1 -p 5433 -d wms -U wms
          psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c 'select version();'

      - name: ðŸ—ƒ Alembic migrate â†’ head
        run: |
          alembic upgrade head

      - name: ðŸŒ± Bootstrap minimal domain
        run: |
          python scripts/bootstrap_domain_min.py --store ä¸»åº—A --items 777,778
          psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c \
            "UPDATE stocks SET qty=10 WHERE item_id=777 AND location_id=1;"
          psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c \
            "UPDATE stocks SET qty=7  WHERE item_id=778 AND location_id=1;"

      - name: ðŸ§¾ Reconcile (shadow) â†’ CSV
        run: |
          mkdir -p var/reconcile
          python scripts/reconcile_pdd_daily.py --store-id 1 --out var/reconcile/pdd_ci.csv --verbose

      - name: ðŸ“Ž Upload reconcile CSV
        uses: actions/upload-artifact@v4
        with:
          name: reconcile-csv
          path: var/reconcile/pdd_ci.csv

      - name: ðŸ§¹ Cleanup postgres
        if: always()
        run: docker rm -f pg14 >/dev/null 2>&1 || true

      - name: ðŸªµ Dump PG logs on failure
        if: failure()
        run: |
          echo "---- docker logs pg14 ----"
          docker logs pg14 || true

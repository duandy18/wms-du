name: L2 Reconcile (Shadow CSV Artifact)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: l2-reconcile-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  PYTHONPATH: "."
  TZ: Asia/Shanghai
  # 与项目一致：容器 5432 → host 5433
  DATABASE_URL: postgresql+psycopg://wms:wms@127.0.0.1:5433/wms
  # 影子模式：不从平台拉真实库存（如需拉数改为 true）
  ENABLE_PDD_PULL: "false"

jobs:
  reconcile-shadow:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4

      - name: 🐍 Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: 📦 Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends postgresql-client

      - name: 📦 Install Python deps
        run: |
          python -m pip install -U pip wheel setuptools
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f .github/ci/requirements-ci.txt ]; then pip install -r .github/ci/requirements-ci.txt; fi
          pip install "psycopg[binary]>=3.1" asyncpg

      - name: 🐘 Start Postgres 14 (5433)
        run: |
          docker run -d --rm --name pg14 \
            -e POSTGRES_USER=wms \
            -e POSTGRES_PASSWORD=wms \
            -e POSTGRES_DB=wms \
            -p 5433:5432 postgres:14
          # 等待数据库可用
          for i in {1..120}; do
            pg_isready -h 127.0.0.1 -p 5433 && break
            sleep 1
          done
          pg_isready -h 127.0.0.1 -p 5433 -d wms -U wms
          psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c 'select version();'

      - name: 🗃 Alembic migrate → head
        run: |
          alembic upgrade head

      - name: 🌱 Bootstrap minimal domain
        run: |
          python scripts/bootstrap_domain_min.py --store 主店A --items 777,778
          psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c \
            "UPDATE stocks SET qty=10 WHERE item_id=777 AND location_id=1;"
          psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c \
            "UPDATE stocks SET qty=7  WHERE item_id=778 AND location_id=1;"

      - name: 🧾 Reconcile (shadow) → CSV
        run: |
          mkdir -p var/reconcile
          python scripts/reconcile_pdd_daily.py --store-id 1 --out var/reconcile/pdd_ci.csv --verbose

      - name: 📎 Upload reconcile CSV
        uses: actions/upload-artifact@v4
        with:
          name: reconcile-csv
          path: var/reconcile/pdd_ci.csv

      - name: 🧹 Cleanup postgres
        if: always()
        run: docker rm -f pg14 >/dev/null 2>&1 || true

      - name: 🪵 Dump PG logs on failure
        if: failure()
        run: |
          echo "---- docker logs pg14 ----"
          docker logs pg14 || true

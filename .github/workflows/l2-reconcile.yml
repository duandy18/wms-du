name: L2 Reconcile (Shadow)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  reconcile-shadow:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
      PYTHONPATH: .
      DATABASE_URL: postgresql+psycopg://wms:wms@127.0.0.1:5433/wms
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Start Postgres (5433)
        run: |
          docker run -d --rm --name pg14 \
            -e POSTGRES_PASSWORD=wms -e POSTGRES_USER=wms -e POSTGRES_DB=wms \
            -p 5433:5432 postgres:14
          sleep 10
          pg_isready -h 127.0.0.1 -p 5433 -d wms -U wms

      - name: Alembic migrate
        run: alembic upgrade head

      - name: Bootstrap minimal domain
        run: |
          python scripts/bootstrap_domain_min.py --store 主店A --items 777,778
          psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c \
            "UPDATE stocks SET qty=10 WHERE item_id=777 AND location_id=1;"
          psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c \
            "UPDATE stocks SET qty=7  WHERE item_id=778 AND location_id=1;"

      - name: Reconcile (shadow) → CSV
        run: |
          mkdir -p var/reconcile
          python scripts/reconcile_pdd_daily.py --store-id 1 --out var/reconcile/pdd_ci.csv
          test -s var/reconcile/pdd_ci.csv

      # 目前平台库存未接入，delta= -visible 是正常的。
      # 等接入 PDD 拉数后，打开下面断言脚本并设定阈值。
      #- name: Assert delta within threshold
      #  run: |
      #    python scripts/assert_delta_within.py --csv var/reconcile/pdd_ci.csv --max-abs-delta 0

      - name: Upload reconcile artifact
        uses: actions/upload-artifact@v4
        with:
          name: reconcile-csv
          path: var/reconcile/pdd_ci.csv

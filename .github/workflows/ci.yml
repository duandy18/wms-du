name: WMS-DU CI (PG + pytest)

on:
  push:
    branches: [ "main", "feat/**", "chore/**" ]
  pull_request:
    branches: [ "main" ]

env:
  PYTHONUNBUFFERED: "1"
  PYTHONPATH: "."
  TZ: Asia/Shanghai
  # PG service 容器 5432 → host 5433，与本地一致
  DATABASE_URL: postgresql+psycopg://wms:wms@127.0.0.1:5433/wms
  # 基线 revision（来自你仓库的 baseline）
  BASELINE_REV: f995a82ac74e

jobs:
  tests:
    name: Quick + Smoke on PostgreSQL
    runs-on: ubuntu-latest
    timeout-minutes: 40

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: wms
          POSTGRES_PASSWORD: wms
          POSTGRES_DB: wms
        ports: [ "5433:5432" ]
        options: >-
          --health-cmd "pg_isready -U wms"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4

      - name: 🐍 Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: 📦 Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends postgresql-client build-essential

      - name: 📦 Install Python deps
        run: |
          python -m pip install -U pip wheel setuptools
          # 项目依赖（存在就装）
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f .github/ci/requirements-ci.txt ]; then pip install -r .github/ci/requirements-ci.txt; fi
          # 必要驱动：psycopg v3 + asyncpg
          pip install "psycopg[binary]>=3.1" asyncpg

      - name: 🔎 Show env
        run: |
          python -V
          echo "TZ=${TZ}"
          echo "PYTHONPATH=${PYTHONPATH}"
          echo "DATABASE_URL=${DATABASE_URL}"

      - name: ⏳ Wait PostgreSQL ready
        env:
          PGPASSWORD: wms
        run: |
          echo "Waiting for Postgres on 127.0.0.1:5433 ..."
          for i in {1..120}; do
            pg_isready -h 127.0.0.1 -p 5433 && break
            sleep 1
          done
          pg_isready -h 127.0.0.1 -p 5433 -d wms -U wms
          psql "postgresql://wms:${PGPASSWORD}@127.0.0.1:5433/wms" -c 'select version();'

      # ------- 两段式迁移：先基线，再扩列，再到 head -------
      - name: 🗃 Alembic migrate (phase-1 baseline only)
        run: |
          echo ">>> Phase-1: upgrade to baseline ${BASELINE_REV}"
          alembic upgrade "${BASELINE_REV}"

      - name: 🛠️ Widen alembic_version.version_num to 255 (after baseline)
        env:
          PGPASSWORD: wms
        run: |
          echo ">>> Widen alembic_version.version_num"
          psql "postgresql://wms:${PGPASSWORD}@127.0.0.1:5433/wms" <<'SQL'
          DO $$
          BEGIN
            BEGIN
              ALTER TABLE alembic_version
              ALTER COLUMN version_num TYPE VARCHAR(255);
            EXCEPTION WHEN undefined_table THEN
              NULL;
            END;
          END $$;
          SQL

      - name: 🗃 Alembic migrate (phase-2 → head, with heads fallback)
        run: |
          echo ">>> Phase-2: upgrade to head"
          set +e
          alembic upgrade head
          rc=$?
          set -e
          if [ $rc -ne 0 ]; then
            echo "::warning::alembic upgrade head failed (maybe multiple heads). Dumping heads and trying 'alembic upgrade heads'..."
            alembic heads -v || true
            alembic upgrade heads
          fi
      # ------- 两段式迁移结束 -------

      # （可选）引导最小域与影子对账，便于集成冒烟
      # - name: 🌱 Bootstrap minimal domain
      #   run: |
      #     python scripts/bootstrap_domain_min.py --store 主店A --items 777,778
      #     psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c \
      #       "UPDATE stocks SET qty=10 WHERE item_id=777 AND location_id=1;"
      #     psql "postgresql://wms:wms@127.0.0.1:5433/wms" -c \
      #       "UPDATE stocks SET qty=7  WHERE item_id=778 AND location_id=1;"

      - name: ✅ Run CI invariants (tests/ci)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          pytest -q tests/ci -s

      - name: 🚀 Run Quick tests (tests/quick)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          pytest -q tests/quick -s

      - name: 🔥 Run Smoke tests (tests/smoke)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          pytest -q tests/smoke -s

      # （可选）对账 CSV 构件：取消注释即可启用
      # - name: 🧾 Shadow reconcile artifact (optional)
      #   run: |
      #     mkdir -p var/reconcile
      #     python scripts/reconcile_pdd_daily.py --store-id 1 --out var/reconcile/pdd_ci.csv
      #
      # - name: 📎 Upload reconcile CSV
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: reconcile-csv
      #     path: var/reconcile/pdd_ci.csv

      - name: 🧹 Dump PG logs on failure (debug helper)
        if: failure()
        run: |
          echo "---- docker logs pg14 (if exists) ----"
          docker logs $(docker ps -q -f "ancestor=postgres:14-alpine") || true

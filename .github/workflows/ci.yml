name: WMS-DU CI (PG + pytest)

on:
  push:
    branches: [ "main", "feat/**", "chore/**" ]
  pull_request:
    branches: [ "main" ]

env:
  PYTHONUNBUFFERED: "1"
  PYTHONPATH: "."
  # PG service å®¹å™¨ 5432 â†’ host 5433ï¼Œä¸æœ¬åœ°ä¸€è‡´
  DATABASE_URL: postgresql+psycopg://wms:wms@127.0.0.1:5433/wms

jobs:
  tests:
    name: Quick + Smoke on PostgreSQL
    runs-on: ubuntu-latest
    timeout-minutes: 35

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: wms
          POSTGRES_PASSWORD: wms
          POSTGRES_DB: wms
        ports: [ "5433:5432" ]
        options: >-
          --health-cmd "pg_isready -U wms"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends postgresql-client build-essential

      - name: ğŸ“¦ Install Python deps
        run: |
          python -m pip install -U pip wheel setuptools
          # é¡¹ç›®ä¾èµ–ï¼ˆå­˜åœ¨å°±è£…ï¼‰
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f .github/ci/requirements-ci.txt ]; then pip install -r .github/ci/requirements-ci.txt; fi
          # å…³é”®ï¼šPG é©±åŠ¨ï¼ˆv3ï¼‰ä¸ async é©±åŠ¨ï¼Œç¡®ä¿ Alembic/async engine å¯ç”¨
          pip install "psycopg[binary]>=3.1" asyncpg

      - name: ğŸ” Show env
        run: |
          python -V
          echo "DATABASE_URL=${DATABASE_URL}"

      - name: â³ Wait PostgreSQL ready
        env:
          PGPASSWORD: wms
        run: |
          echo "Waiting for Postgres on 127.0.0.1:5433 ..."
          for i in {1..60}; do
            pg_isready -h 127.0.0.1 -p 5433 && break
            sleep 2
          done
          psql "postgresql://wms:${PGPASSWORD}@127.0.0.1:5433/wms" -c 'select 1;'

      # å…³é”®æ­¥éª¤ï¼šå¦‚æœå­˜åœ¨ alembic_version ä¸” version_num é•¿åº¦ä¸º 32ï¼Œåˆ™æ‰©ä¸º 255
      - name: ğŸ› ï¸ Widen alembic_version.version_num to 255 if needed
        env:
          PGPASSWORD: wms
        run: |
          psql "postgresql://wms:${PGPASSWORD}@127.0.0.1:5433/wms" <<'SQL'
          DO $$
          BEGIN
            IF EXISTS (
              SELECT 1
              FROM information_schema.columns
              WHERE table_name='alembic_version'
                AND column_name='version_num'
                AND character_maximum_length = 32
            ) THEN
              ALTER TABLE alembic_version
              ALTER COLUMN version_num TYPE VARCHAR(255);
            END IF;
          EXCEPTION WHEN undefined_table THEN
            -- å…¨æ–°åº“ï¼šè¡¨å°šæœªåˆ›å»ºï¼Œå¿½ç•¥ï¼›åŸºçº¿è¿ç§»ä¼šåˆ›å»ºæ­¤è¡¨
            NULL;
          END $$;
          SQL

      - name: ğŸ—ƒ Alembic migrate (head â†’ heads fallback)
        run: |
          set +e
          alembic upgrade head
          rc=$?
          set -e
          if [ $rc -ne 0 ]; then
            echo "alembic upgrade head failed (maybe multiple heads). Trying 'alembic upgrade heads'..."
            alembic upgrade heads
          fi

      - name: âœ… Run CI invariants (tests/ci)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          pytest -q tests/ci -s

      - name: ğŸš€ Run Quick tests (tests/quick)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          pytest -q tests/quick -s

      - name: ğŸ”¥ Run Smoke tests (tests/smoke)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          pytest -q tests/smoke -s

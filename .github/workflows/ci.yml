name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:

jobs:
  schema-check:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        ports: ["5432:5432"]
        env:
          POSTGRES_DB: wms
          POSTGRES_USER: wms
          POSTGRES_PASSWORD: wms
        options: >-
          --health-cmd="pg_isready -U wms -d wms"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      DATABASE_URL: postgresql+psycopg://wms:wms@localhost:5432/wms
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Create venv & install deps
        run: |
          python -m venv .venv
          ./.venv/bin/pip install -U pip setuptools wheel
          if [ -f requirements.txt ]; then ./.venv/bin/pip install -r requirements.txt; fi
          if [ -f backend/requirements.txt ]; then ./.venv/bin/pip install -r backend/requirements.txt; fi
          ./.venv/bin/pip install "alembic>=1.13" "psycopg[binary]>=3.1" "pytest" "regex" "ripgrep-bin"

      - name: Alembic check (Phase 3)
        run: |
          MODEL_IMPORT_SCOPE=phase3 ALEMBIC_CHECK_SCOPE=phase3 ./.venv/bin/python -m alembic check

      - name: Alembic check (Phase 2)
        run: |
          MODEL_IMPORT_SCOPE=phase2 ALEMBIC_CHECK_SCOPE=phase2 ./.venv/bin/python -m alembic check

      - name: Guard no compat leftovers
        run: |
          # 兼容：没有 ripgrep 可用时，使用 python 简替
          if command -v rg >/dev/null 2>&1; then
            rg -n "_safe_import\\(\"app\\.models\\.compat_" app/models/__init__.py && exit 1 || true
          else
            python - <<'PY'
import sys, re, pathlib
p = pathlib.Path("app/models/__init__.py")
s = p.read_text(encoding="utf-8") if p.exists() else ""
if re.search(r'_safe_import\("app\.models\.compat_', s):
    print("compat imports found in app/models/__init__.py", file=sys.stderr)
    sys.exit(1)
PY
          fi
          if ls app/models/compat_*.py 2>/dev/null; then
            echo "compat files still under app/models"; exit 1
          fi

  # 可选：跑迷你测试
  mini-tests:
    needs: schema-check
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        ports: ["5432:5432"]
        env:
          POSTGRES_DB: wms
          POSTGRES_USER: wms
          POSTGRES_PASSWORD: wms
        options: >-
          --health-cmd="pg_isready -U wms -d wms"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    env:
      DATABASE_URL: postgresql+psycopg://wms:wms@localhost:5432/wms
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Create venv & install deps
        run: |
          python -m venv .venv
          ./.venv/bin/pip install -U pip setuptools wheel
          if [ -f requirements.txt ]; then ./.venv/bin/pip install -r requirements.txt; fi
          if [ -f backend/requirements.txt ]; then ./.venv/bin/pip install -r backend/requirements.txt; fi
          ./.venv/bin/pip install "pytest"

      - name: Run mini suites
        run: |
          make test-outbound-mini
          make test-platform-mini
          make test-reserve-mini
          make test-reserve-lifecycle
          make test-metrics-mini
